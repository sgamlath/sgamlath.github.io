<!DOCTYPE html>
<html>
  <head>
    <title>TrainMap(beta)</title>
    <meta name="theme-color" content="#2196F3">
    <meta name="viewport" content="width=device-width">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <style>
      #map {position: absolute; top: 0; right: 0; bottom: 0; left: 0;}
    </style>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="//www.parsecdn.com/js/parse-1.6.0.min.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '{{ site.google_analytics }}']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <script>
    var markers=[];
    var map;
    function setDummyData(){
      var DummyLocation = Parse.Object.extend("Location");
      var query = new Parse.Query(DummyLocation);
      var dummyLocation;
      query.equalTo("userId", "dummy");
      query.find({
        success: function(results) {
          console.log("total dummy locations "+results.length);
          if (results.length>0) {
            dummyLocation=results[0]
          }else {
            dummyLocation = new DummyLocation();
            dummyLocation.set("userId", 'dummy');
            var loc = new Parse.GeoPoint({latitude: 6.902250, longitude: 79.861314});
            dummyLocation.set("trainName", "TS0");
            dummyLocation.set("loc", loc);
        }
          dummyLocation.set("speed", Math.random()*20);
          dummyLocation.save(null, {
            success: function(dummyLocation) {
              // Execute any logic that should take place after the object is saved.
              // alert('New object created with objectId: ' + dummyLocation.id);
            },
            error: function(dummyLocation, error) {
              // Execute any logic that should take place if the save fails.
              // error is a Parse.Error with an error code and message.
              // alert('Failed to create new object, with error code: ' + error.message);
            }
          });
      },
        error: function(error) {
          console.log("Error: " + error.code + " " + error.message);
        }
      });
    }
    function updateMap(){
      var Location = Parse.Object.extend("Location");
      var query = new Parse.Query(Location);
      query.find({
        success: function(results) {
          deleteMarkers();
          for (var i = 0; i < results.length; i++) {
            var object = results[i];
            var userGeoPoint = object.get("loc");
            var infowindow = new google.maps.InfoWindow({
              content: (object.get("trainName")).concat("/",Math.round(object.get("speed")*18/5))
            });
            var myMarker = new google.maps.Marker({
              position: new google.maps.LatLng(userGeoPoint._latitude, userGeoPoint._longitude),
              map: map,
              // title : 'hello world'
            });
            infowindow.open(map, myMarker);
            markers.push(myMarker)
          }
          setMapOnAll(map);
          // setDummyData();
          setTimeout(updateMap, 5000);
        },
        error: function(error) {
          console.log("Error: " + error.code + " " + error.message);
          setTimeout(updateMap, 5000);
        }
      });

    }
    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
      }
    }

    function clearMarkers() {
      setMapOnAll(null);
    }

    function deleteMarkers() {
      clearMarkers();
      markers = [];
    }

      function initialize() {
        var mapCanvas = document.getElementById('map');
        var mapOptions = {
          center: new google.maps.LatLng(7.8578, 81.0000),
          zoom: 8,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        map = new google.maps.Map(mapCanvas, mapOptions);
      }
      Parse.initialize("lGi3e36YTg0ujCeSwqggXMmCqOvjQIwEWXwruYwT", "SDWSoOnXvwSqMZqRKjp5OLJXUEa9cs6JTI8moDGE");
      google.maps.event.addDomListener(window, 'load', initialize);
      updateMap();
    </script>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>
